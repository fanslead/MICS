# MICS ç¦»çº¿æ¶ˆæ¯ä¼˜åŒ–æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2024  
> **æ–¹æ¡ˆç±»å‹**: æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ  
> **ä¼˜å…ˆçº§**: P0 - å…³é”®ä¼˜åŒ–

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### å½“å‰é—®é¢˜

MICSå½“å‰å°†æ‰€æœ‰ç¦»çº¿æ¶ˆæ¯å­˜å‚¨åœ¨GatewayèŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

1. **æ•°æ®ä¸¢å¤±é£é™©** ğŸ”´ - èŠ‚ç‚¹é‡å¯/å´©æºƒæ—¶æ‰€æœ‰ç¦»çº¿æ¶ˆæ¯ä¸¢å¤±
2. **å®¹é‡é™åˆ¶** ğŸŸ¡ - å•èŠ‚ç‚¹å†…å­˜æœ‰é™ï¼Œæ— æ³•æ”¯æ’‘å¤§é‡ç¦»çº¿æ¶ˆæ¯
3. **è¿èƒŒè®¾è®¡åŸåˆ™** ğŸŸ¡ - Gatewayåº”ä¸ºçº¯è½¬å‘å±‚ï¼Œä¸åº”å­˜å‚¨ä¸šåŠ¡æ•°æ®

### ä¼˜åŒ–ç›®æ ‡

1. **å¯é æ€§è¾¹ç•Œæ¸…æ™°**: ç¦»çº¿æ¶ˆæ¯å¯é æ€§ç”±ä¸šåŠ¡æ–¹ï¼ˆKafka æ¶ˆè´¹ + å­˜å‚¨ï¼‰ä¿éšœï¼›Gateway ä»… best-effort é€šçŸ¥ä¸æ‹‰å–è¡¥å‘
2. **é›¶å­˜å‚¨ + å¯é™çº§**: Gateway ä¸æŒä¹…åŒ–ä¸šåŠ¡æ•°æ®ï¼›å…è®¸çŸ­æœŸå†…å­˜ç¼“å†²ä½œä¸ºé™çº§ï¼ˆTTL å¯é…ç½®ï¼‰
3. **æ¶æ„æ¸…æ™°**: èŒè´£åˆ†ç¦»ï¼ŒGatewayä¸“æ³¨å®æ—¶è½¬å‘
4. **ä¸šåŠ¡çµæ´»**: ä¸šåŠ¡æ–¹å®Œå…¨æ§åˆ¶ç¦»çº¿æ¶ˆæ¯å¤„ç†é€»è¾‘

### æ¨èæ–¹æ¡ˆ

**Kafkaå¼‚æ­¥é€šçŸ¥ + HookåŒæ­¥æ‹‰å–æ··åˆæ–¹æ¡ˆ**

```
ç¦»çº¿æ¶ˆæ¯äº§ç”Ÿ â†’ Kafkaäº‹ä»¶ â†’ ä¸šåŠ¡æ–¹å­˜å‚¨ â†’ ç”¨æˆ·ä¸Šçº¿ â†’ Hookæ‹‰å– â†’ Gatewayæ¨é€
```

**é¢„æœŸæ”¶ç›Š**:
- Gatewayå†…å­˜å ç”¨é™ä½ **80%**
- ç¦»çº¿æ¶ˆæ¯å¯é æ€§æå‡ï¼ˆå–å†³äºä¸šåŠ¡ä¾§å­˜å‚¨ä¸æ¶ˆè´¹ä¿éšœï¼›Gateway ä¸º best-effortï¼‰
- ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§æå‡è‡³ **99.95%+**
- ä¸šåŠ¡æ–¹è·å¾—å®Œå…¨æ§åˆ¶æƒ

---

## ç›®å½•

1. [ç°çŠ¶åˆ†æ](#1-ç°çŠ¶åˆ†æ)
2. [æ–¹æ¡ˆå¯¹æ¯”](#2-æ–¹æ¡ˆå¯¹æ¯”)
3. [æ¨èæ–¹æ¡ˆè¯¦ç»†è®¾è®¡](#3-æ¨èæ–¹æ¡ˆè¯¦ç»†è®¾è®¡)
4. [æŠ€æœ¯å®æ–½æ–¹æ¡ˆ](#4-æŠ€æœ¯å®æ–½æ–¹æ¡ˆ)
5. [å®¹é”™ä¸é™çº§è®¾è®¡](#5-å®¹é”™ä¸é™çº§è®¾è®¡)
6. [æ€§èƒ½ä¸å®¹é‡è§„åˆ’](#6-æ€§èƒ½ä¸å®¹é‡è§„åˆ’)
7. [å®æ–½è·¯çº¿å›¾](#7-å®æ–½è·¯çº¿å›¾)
8. [é£é™©è¯„ä¼°ä¸åº”å¯¹](#8-é£é™©è¯„ä¼°ä¸åº”å¯¹)
9. [ç›‘æ§ä¸è¿ç»´](#9-ç›‘æ§ä¸è¿ç»´)
10. [æ€»ç»“ä¸å»ºè®®](#10-æ€»ç»“ä¸å»ºè®®)

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰ç¦»çº¿æ¶ˆæ¯æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç¦»çº¿æ”¶åˆ°æ¶ˆæ¯
    â†“
Gatewayæ£€æµ‹ç¦»çº¿
    â†“
å­˜å‚¨åˆ°å†…å­˜Dictionary
    â†“
    [ç­‰å¾…ç”¨æˆ·ä¸Šçº¿]
    â†“
ç”¨æˆ·ä¸Šçº¿
    â†“
ä»å†…å­˜è¯»å–
    â†“
æ¨é€ç»™ç”¨æˆ·
```

**å®ç°ä»£ç **:
```csharp
// src/Mics.Gateway/Offline/OfflineBufferStore.cs
internal sealed class OfflineBufferStore : IOfflineBufferStore
{
    private readonly Dictionary<(string TenantId, string UserId), Buffer> _buffers = new();
    
    public bool TryAdd(string tenantId, string userId, byte[] serverFrameBytes, TimeSpan ttl)
    {
        // å­˜å‚¨åœ¨å†…å­˜ä¸­
        lock (_lock) {
            var key = (tenantId, userId);
            if (!_buffers.TryGetValue(key, out var buffer)) {
                buffer = new Buffer();
                _buffers[key] = buffer;
            }
            buffer.Items.Enqueue(new Item(serverFrameBytes, expiresAt));
            return true;
        }
    }
}
```

---

### 1.2 é—®é¢˜åˆ†æ

#### é—®é¢˜1: æ•°æ®ä¸¢å¤±é£é™© ğŸ”´ ä¸¥é‡

**åœºæ™¯æè¿°**:
```
æ—¶é—´è½´ï¼š
T1: ç”¨æˆ·Aç¦»çº¿
T2: ç”¨æˆ·Bå‘é€10æ¡æ¶ˆæ¯ç»™A
T3: Gatewayå°†10æ¡æ¶ˆæ¯ç¼“å­˜åˆ°å†…å­˜
T4: GatewayèŠ‚ç‚¹å› æ•…éšœé‡å¯
T5: ç”¨æˆ·Aä¸Šçº¿
ç»“æœ: 10æ¡æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤± âŒ
```

**å½±å“èŒƒå›´**:
- æ‰€æœ‰ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯
- é«˜å³°æœŸå•èŠ‚ç‚¹å¯èƒ½ç¼“å­˜æ•°ä¸‡æ¡æ¶ˆæ¯
- ç”¨æˆ·ä½“éªŒä¸¥é‡å—æŸ

**ä¸šåŠ¡å½±å“**:
- é‡è¦æ¶ˆæ¯æœªé€è¾¾ï¼ˆè®¢å•é€šçŸ¥ã€ç³»ç»Ÿå…¬å‘Šç­‰ï¼‰
- ç”¨æˆ·æŠ•è¯‰ç‡ä¸Šå‡
- æ•°æ®å®Œæ•´æ€§æ— æ³•ä¿è¯

---

#### é—®é¢˜2: å®¹é‡é™åˆ¶ ğŸŸ¡ ä¸­ç­‰

**å®¹é‡è®¡ç®—**:
```
å‡è®¾ï¼š
- å•èŠ‚ç‚¹æ‰¿è½½10ä¸‡åœ¨çº¿ç”¨æˆ·
- å¹³å‡æ¯äºº10æ¡ç¦»çº¿æ¶ˆæ¯
- æ¯æ¡æ¶ˆæ¯1KB

æ€»å†…å­˜å ç”¨ = 10ä¸‡ Ã— 10 Ã— 1KB = 1GB
```

**é—®é¢˜**:
1. å†…å­˜å ç”¨é«˜ï¼Œå½±å“å…¶ä»–åŠŸèƒ½
2. è¾¾åˆ°ä¸Šé™åæ— æ³•æ¥æ”¶æ–°ç¦»çº¿æ¶ˆæ¯
3. GCå‹åŠ›å¢å¤§ï¼Œå½±å“æ€§èƒ½

---

#### é—®é¢˜3: è¿èƒŒè®¾è®¡åŸåˆ™ ğŸŸ¡ ä¸­ç­‰

**è®¾è®¡åŸåˆ™**:
> Gatewayåº”è¯¥æ˜¯ä¸€ä¸ª**çº¯ç²¹çš„å®æ—¶æ¶ˆæ¯è½¬å‘å±‚**ï¼Œä¸åº”è¯¥å­˜å‚¨ä»»ä½•ä¸šåŠ¡æ•°æ®

**å½“å‰é—®é¢˜**:
- Gatewayæ—¢åšè½¬å‘ï¼Œåˆåšå­˜å‚¨
- èŒè´£ä¸æ¸…æ™°
- éš¾ä»¥ç‹¬ç«‹æ‰©å±•

---

### 1.3 ä¼˜åŒ–å¿…è¦æ€§

| ç»´åº¦ | å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| **æ•°æ®å¯é æ€§** | âŒ å†…å­˜æ˜“å¤± | âœ… æŒä¹…åŒ–å­˜å‚¨ | ğŸ”´ P0 |
| **ç³»ç»Ÿå¯ç”¨æ€§** | âš ï¸ èŠ‚ç‚¹é‡å¯å½±å“å¤§ | âœ… æ— çŠ¶æ€èŠ‚ç‚¹ | ğŸ”´ P0 |
| **æ¶æ„æ¸…æ™°åº¦** | âš ï¸ èŒè´£æ··ä¹± | âœ… èŒè´£åˆ†ç¦» | ğŸŸ¡ P1 |
| **ä¸šåŠ¡çµæ´»æ€§** | âŒ æ— æ³•å®šåˆ¶ | âœ… å®Œå…¨å¯æ§ | ğŸŸ¡ P1 |
| **æ‰©å±•æ€§** | âš ï¸ å—å†…å­˜é™åˆ¶ | âœ… æ— é™æ‰©å±• | ğŸŸ¢ P2 |

---

## 2. æ–¹æ¡ˆå¯¹æ¯”

### 2.1 æ–¹æ¡ˆä¸€ï¼šRedis StreamæŒä¹…åŒ–

#### æ–¹æ¡ˆæè¿°

```
ç”¨æˆ·ç¦»çº¿ â†’ Gatewayå†™å…¥Redis Stream â†’ ç”¨æˆ·ä¸Šçº¿ â†’ Gatewayä»Redisè¯»å– â†’ æ¨é€
```

#### ä¼˜åŠ¿ âœ…

1. **å®ç°ç®€å•**: Gatewayå†…éƒ¨å®ç°ï¼Œä¸šåŠ¡æ–¹æ— æ„ŸçŸ¥
2. **æ€§èƒ½é«˜**: Redis Streamå†™å…¥é€Ÿåº¦å¿«ï¼ˆ10ä¸‡+TPSï¼‰
3. **æ”¯æŒTTL**: å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´è‡ªåŠ¨æ¸…ç†
4. **ä»£ç æ”¹åŠ¨å°**: åªéœ€ä¿®æ”¹OfflineBufferStoreå®ç°

#### åŠ£åŠ¿ âŒ

1. **ä»åœ¨å­˜å‚¨ä¸šåŠ¡æ•°æ®**: è¿èƒŒ"Gatewayä¸å­˜å‚¨ä¸šåŠ¡æ•°æ®"åŸåˆ™
2. **å®¹é‡æœ‰é™**: Rediså†…å­˜æœ‰é™ï¼Œå¤§é‡ç¦»çº¿æ¶ˆæ¯ä¼šæ’‘çˆ†
3. **å•ç‚¹é£é™©**: Redisæ•…éšœä»ç„¶å¯¼è‡´ç¦»çº¿æ¶ˆæ¯ä¸¢å¤±
4. **æˆæœ¬é«˜**: éœ€è¦å¤§å®¹é‡Redisé›†ç¾¤

#### è¯„ä¼°ç»“è®º

âš ï¸ **ä¸æ¨è** - æœªè§£å†³æ¶æ„å±‚é¢çš„æ ¹æœ¬é—®é¢˜

---

### 2.2 æ–¹æ¡ˆäºŒï¼šHookåŒæ­¥è°ƒç”¨å­˜å‚¨

#### æ–¹æ¡ˆæè¿°

```
ç”¨æˆ·ç¦»çº¿ â†’ Gatewayè°ƒç”¨StoreOfflineMessage Hook â†’ ä¸šåŠ¡æ–¹å­˜å‚¨ â†’ ç”¨æˆ·ä¸Šçº¿ â†’ Hookæ‹‰å–
```

#### ä¼˜åŠ¿ âœ…

1. **å®Œå…¨æ— çŠ¶æ€**: Gatewayä¸å­˜å‚¨ä»»ä½•æ•°æ®
2. **ä¸šåŠ¡å¯æ§**: ä¸šåŠ¡æ–¹å†³å®šå­˜å‚¨ç­–ç•¥
3. **æ¶æ„æ¸…æ™°**: èŒè´£åˆ†ç¦»æ˜ç¡®

#### åŠ£åŠ¿ âŒ

1. **å»¶è¿Ÿå¢åŠ **: æ¯æ¡ç¦»çº¿æ¶ˆæ¯éƒ½éœ€è¦åŒæ­¥è°ƒç”¨Hookï¼ˆ150ms+ï¼‰
2. **Hookä¾èµ–**: HookæœåŠ¡æ•…éšœä¼šå¯¼è‡´ç¦»çº¿æ¶ˆæ¯ä¸¢å¤±
3. **æ€§èƒ½ç“¶é¢ˆ**: é«˜å¹¶å‘æ—¶Hookå¯èƒ½æˆä¸ºç“¶é¢ˆ
4. **é˜»å¡ä¸»æµç¨‹**: å½±å“å®æ—¶æ¶ˆæ¯æŠ•é€’æ€§èƒ½

#### è¯„ä¼°ç»“è®º

âš ï¸ **ä¸æ¨è** - æ€§èƒ½é—®é¢˜ä¸¥é‡ï¼Œå½±å“å®æ—¶æ¶ˆæ¯

---

### 2.3 æ–¹æ¡ˆä¸‰ï¼šKafkaå¼‚æ­¥é€šçŸ¥ + Hookæ‹‰å–ï¼ˆæ¨èï¼‰â­

#### æ–¹æ¡ˆæè¿°

```
ç¦»çº¿æ¶ˆæ¯ â†’ Kafkaäº‹ä»¶ï¼ˆå¼‚æ­¥ï¼‰â†’ ä¸šåŠ¡æ–¹å­˜å‚¨
ç”¨æˆ·ä¸Šçº¿ â†’ Hookæ‹‰å–ï¼ˆåŒæ­¥ï¼‰â†’ Gatewayæ¨é€
```

#### ä¼˜åŠ¿ âœ…

1. **å®Œå…¨æ— çŠ¶æ€**: Gatewayä¸å­˜å‚¨ä»»ä½•ä¸šåŠ¡æ•°æ® âœ…
2. **å¼‚æ­¥éé˜»å¡**: Kafkaæ¨é€ä¸é˜»å¡ä¸»æµç¨‹ âœ…
3. **å¯é æ€§å¤–ç½®**: ç¦»çº¿è·¯å¾„ç”±ä¸šåŠ¡ä¾§ï¼ˆKafkaæ¶ˆè´¹ + å­˜å‚¨ï¼‰ä¿éšœï¼›Gatewayä»…best-efforté€šçŸ¥ä¸æ‹‰å– âœ…
4. **ä¸šåŠ¡çµæ´»**: ä¸šåŠ¡æ–¹å®Œå…¨æ§åˆ¶å­˜å‚¨å’Œæ¨é€é€»è¾‘ âœ…
5. **æ€§èƒ½ä¼˜å¼‚**: ä¸å½±å“å®æ—¶æ¶ˆæ¯TPS âœ…
6. **å¯è§‚æµ‹æ€§å¼º**: Kafkaäº‹ä»¶å¯å›æº¯ã€å®¡è®¡ âœ…
7. **å®¹é”™æ€§å¥½**: å¤šé‡é™çº§ç­–ç•¥ âœ…

#### åŠ£åŠ¿ âš ï¸

1. **å®ç°å¤æ‚åº¦**: ä¸šåŠ¡æ–¹éœ€è¦å®ç°Kafkaæ¶ˆè´¹ + Hookæ¥å£
2. **å­¦ä¹ æˆæœ¬**: å›¢é˜Ÿéœ€è¦ç†Ÿæ‚‰Kafka

#### è¯„ä¼°ç»“è®º

â­ **å¼ºçƒˆæ¨è** - æœ€ä½³æ¶æ„æ–¹æ¡ˆï¼Œé•¿æœŸæ”¶ç›Šæœ€å¤§

---

### 2.4 æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| ç»´åº¦ | æ–¹æ¡ˆä¸€<br/>Redis Stream | æ–¹æ¡ˆäºŒ<br/>HookåŒæ­¥ | æ–¹æ¡ˆä¸‰<br/>Kafka+Hook<br/>â­æ¨è |
|------|---------------------|------------------|---------------------------|
| **æ¶æ„åŸåˆ™** | âŒ è¿èƒŒ | âœ… ç¬¦åˆ | âœ… ç¬¦åˆ |
| **æ•°æ®å¯é æ€§** | âš ï¸ ä¸­ç­‰ | âš ï¸ ä¸­ç­‰ | âœ… æé«˜ |
| **æ€§èƒ½å½±å“** | âš ï¸ ä¸­ç­‰ | âŒ è¾ƒå¤§ | âœ… æå° |
| **å®ç°å¤æ‚åº¦** | âœ… ç®€å• | âœ… ç®€å• | âš ï¸ ä¸­ç­‰ |
| **ä¸šåŠ¡çµæ´»æ€§** | âŒ ä½ | âœ… é«˜ | âœ… æé«˜ |
| **æ‰©å±•æ€§** | âš ï¸ å—é™ | âš ï¸ å—é™ | âœ… æ— é™ |
| **å®¹é”™èƒ½åŠ›** | âš ï¸ ä¸­ç­‰ | âŒ å·® | âœ… ä¼˜ç§€ |
| **è¿ç»´æˆæœ¬** | âœ… ä½ | âœ… ä½ | âš ï¸ ä¸­ç­‰ |
| **é•¿æœŸä»·å€¼** | âŒ ä½ | âš ï¸ ä¸­ç­‰ | âœ… æé«˜ |

**æ¨è**: æ–¹æ¡ˆä¸‰ï¼ˆKafkaå¼‚æ­¥é€šçŸ¥ + Hookæ‹‰å–ï¼‰

---

## 3. æ¨èæ–¹æ¡ˆè¯¦ç»†è®¾è®¡

### 3.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¼˜åŒ–åæ¶æ„å›¾                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·A   â”‚      â”‚ Gateway  â”‚      â”‚  Kafka   â”‚      â”‚ ä¸šåŠ¡ç³»ç»Ÿ  â”‚
â”‚ (ç¦»çº¿)   â”‚      â”‚  é›†ç¾¤    â”‚      â”‚  é›†ç¾¤    â”‚      â”‚ (è‡ªä¸»)   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚  â‘ Bâ†’Aæ¶ˆæ¯        â”‚                 â”‚                 â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â”‚
     â”‚  (Aç¦»çº¿)         â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ â‘¡æ¨é€Kafkaäº‹ä»¶   â”‚                 â”‚
     â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
     â”‚                 â”‚  OFFLINE_MESSAGEâ”‚                 â”‚
     â”‚                 â”‚  (å¼‚æ­¥éé˜»å¡)     â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚ â‘¢æ¶ˆè´¹äº‹ä»¶        â”‚
     â”‚                 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚â‘£å­˜å‚¨MySQL
     â”‚                 â”‚                 â”‚                 â”œâ”€â”€>[DB]
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚  â‘¤Aä¸Šçº¿          â”‚                 â”‚                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚ â‘¥è°ƒç”¨Hookæ‹‰å–                      â”‚
     â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                 â”‚  GetOfflineMessages               â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚â‘¦æŸ¥è¯¢DB
     â”‚                 â”‚                 â”‚                 â”œâ”€â”€>[DB]
     â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                 â”‚  è¿”å›æ¶ˆæ¯åˆ—è¡¨                       â”‚
     â”‚                 â”‚                 â”‚                 â”‚
     â”‚  â‘§æ¨é€ç¦»çº¿æ¶ˆæ¯    â”‚                 â”‚                 â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â”‚
     â”‚  (WebSocket)    â”‚                 â”‚                 â”‚
     â”‚                 â”‚                 â”‚                 â”‚
```

---

### 3.2 æ ¸å¿ƒç»„ä»¶èŒè´£

#### GatewayèŒè´£ï¼ˆè½»é‡åŒ–ï¼‰

```
âœ… åšä»€ä¹ˆï¼š
1. æ£€æµ‹ç”¨æˆ·ç¦»çº¿
2. æ¨é€OFFLINE_MESSAGEäº‹ä»¶åˆ°Kafkaï¼ˆå¼‚æ­¥ï¼‰
3. ç”¨æˆ·ä¸Šçº¿æ—¶è°ƒç”¨GetOfflineMessages Hook
4. å°†Hookè¿”å›çš„æ¶ˆæ¯æ¨é€ç»™å®¢æˆ·ç«¯
5. é‡‡é›†MetricsæŒ‡æ ‡

âŒ ä¸åšä»€ä¹ˆï¼š
1. ä¸å­˜å‚¨ç¦»çº¿æ¶ˆæ¯å†…å®¹
2. ä¸ç®¡ç†ç¦»çº¿æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ
3. ä¸å…³å¿ƒç¦»çº¿æ¶ˆæ¯ä¸šåŠ¡é€»è¾‘
4. ä¸ä¿è¯ç¦»çº¿æ¶ˆæ¯å¿…è¾¾ï¼ˆä¸šåŠ¡æ–¹è´Ÿè´£ï¼‰
```

---

#### KafkaèŒè´£ï¼ˆå¼‚æ­¥æ¡¥æ¢ï¼‰

```
âœ… åšä»€ä¹ˆï¼š
1. å¯é ä¼ é€’OFFLINE_MESSAGEäº‹ä»¶
2. ä¿è¯æ¶ˆæ¯é¡ºåºï¼ˆæŒ‰Partitionï¼‰
3. æ”¯æŒæ¶ˆæ¯å›æº¯ï¼ˆæ—¥å¿—ä¿ç•™ï¼‰
4. è§£è€¦Gatewayä¸ä¸šåŠ¡æ–¹

ğŸ“Š é…ç½®å»ºè®®ï¼š
- Topic: im-mics-{tenantId}-event
- Partitions: 32
- Replication: 3
- Retention: 7å¤©
- Compression: lz4
```

---

#### ä¸šåŠ¡æ–¹èŒè´£ï¼ˆå®Œå…¨è‡ªä¸»ï¼‰

```
âœ… åšä»€ä¹ˆï¼š
1. è®¢é˜…Kafkaçš„OFFLINE_MESSAGEäº‹ä»¶
2. å®ç°ç¦»çº¿æ¶ˆæ¯å­˜å‚¨é€»è¾‘
3. å®ç°GetOfflineMessages Hookæ¥å£
4. ç®¡ç†æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼ˆè¿‡æœŸæ¸…ç†ï¼‰
5. å®ç°ä¸šåŠ¡é€»è¾‘ï¼ˆå»é‡ã€è¿‡æ»¤ã€ä¼˜å…ˆçº§ï¼‰
6. å†³å®šæ˜¯å¦è§¦å‘Appç¦»çº¿æ¨é€
7. ç»Ÿè®¡åˆ†æç¦»çº¿æ¶ˆæ¯æ•°æ®

ğŸ¨ è‡ªç”±åº¦ï¼š
1. é€‰æ‹©å­˜å‚¨æ–¹æ¡ˆï¼ˆMySQL/MongoDB/Redisï¼‰
2. å®šä¹‰ä¿ç•™ç­–ç•¥ï¼ˆ7å¤©/30å¤©/æ°¸ä¹…ï¼‰
3. å®ç°å¤æ‚é€»è¾‘ï¼ˆé»‘åå•ã€æ•æ„Ÿè¯ï¼‰
4. ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ˆç´¢å¼•ã€åˆ†è¡¨ï¼‰
```

---

### 3.3 æ•°æ®æµè¯¦è§£

#### æµç¨‹1ï¼šç¦»çº¿æ¶ˆæ¯äº§ç”Ÿ

```
è§¦å‘ï¼šæ¶ˆæ¯æŠ•é€’å¤±è´¥ï¼ˆç›®æ ‡ç”¨æˆ·ä¸åœ¨çº¿ï¼‰

Step 1: Gatewayæ£€æµ‹ç¦»çº¿
if (routes.Count == 0) {  // æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œæ— åœ¨çº¿è®¾å¤‡
    // è¿›å…¥ç¦»çº¿æ¶ˆæ¯å¤„ç†
}

Step 2: å°è£…Kafkaäº‹ä»¶
var evt = new MqEvent {
    TenantId = tenantId,
    EventType = EventType.OFFLINE_MESSAGE,
    MsgId = message.MsgId,
    UserId = message.UserId,      // å‘é€æ–¹
    ToUserId = toUserId,           // æ¥æ”¶æ–¹ï¼ˆç¦»çº¿ç”¨æˆ·ï¼‰
    EventData = message.ToByteString(),  // åŸå§‹æ¶ˆæ¯
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds(),
    NodeId = nodeId,
    TraceId = traceId,
    Sign = ComputeHmacSign(...)    // é˜²ç¯¡æ”¹
};

Step 3: æ¨é€Kafkaï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
_mq.TryEnqueue(evt);  // å†…å­˜é˜Ÿåˆ—ï¼Œå¼‚æ­¥å‘é€

Step 4: è¿”å›Ackç»™å‘é€æ–¹
await SendAckAsync(socket, new MessageAck {
    MsgId = message.MsgId,
    Status = AckStatus.SENT,
    Reason = "user_offline"
});

Step 5: Gatewayä¸åšä»»ä½•æœ¬åœ°å­˜å‚¨
// å®Œå…¨æ— çŠ¶æ€ âœ…
```

---

#### æµç¨‹2ï¼šä¸šåŠ¡æ–¹æ¶ˆè´¹å¤„ç†

```
Step 1: è®¢é˜…Kafka
Consumerè®¢é˜…Topic: im-mics-{tenantId}-event
Consumer Group: offline-message-consumer-{tenantId}

Step 2: æ¥æ”¶äº‹ä»¶
foreach (var evt in kafkaMessages) {
    if (evt.EventType != EventType.OFFLINE_MESSAGE) continue;
    
    // éªŒè¯ç­¾å
    if (!VerifyHmacSign(evt)) {
        log.Warn("invalid_sign");
        continue;
    }
    
    var message = MessageRequest.Parser.ParseFrom(evt.EventData);
    
    // Step 3: ä¸šåŠ¡é€»è¾‘å¤„ç†
    // âœ… å»é‡
    if (await _db.OfflineMessages.AnyAsync(m => m.MessageId == evt.MsgId)) {
        continue;  // é‡å¤æ¶ˆæ¯ï¼Œè·³è¿‡
    }
    
    // âœ… è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    if (await IsBlacklisted(evt.UserId, evt.ToUserId)) {
        continue;  // é»‘åå•ï¼Œè·³è¿‡
    }
    
    // âœ… æ•æ„Ÿè¯è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    if (ContainsSensitiveWords(message.MsgBody)) {
        message.MsgBody = FilterSensitiveWords(message.MsgBody);
    }
    
    // âœ… ä¼˜å…ˆçº§æ ‡è®°ï¼ˆå¯é€‰ï¼‰
    var priority = await GetUserPriority(evt.ToUserId);  // VIPç”¨æˆ·é«˜ä¼˜å…ˆçº§
    
    // Step 4: æŒä¹…åŒ–å­˜å‚¨
    await _db.OfflineMessages.AddAsync(new OfflineMessage {
        TenantId = evt.TenantId,
        UserId = evt.ToUserId,
        MessageId = evt.MsgId,
        FromUserId = evt.UserId,
        MessageType = message.MsgType,
        MessageData = evt.EventData.ToByteArray(),
        Priority = priority,
        CreatedAt = DateTimeOffset.FromUnixTimeMilliseconds(evt.Timestamp),
        Delivered = false
    });
    
    await _db.SaveChangesAsync();
    
    // Step 5: è§¦å‘é¢å¤–åŠ¨ä½œï¼ˆå¯é€‰ï¼‰
    if (ShouldPushNotification(evt.ToUserId)) {
        await _pushService.SendAsync(evt.ToUserId, "æ‚¨æœ‰æ–°æ¶ˆæ¯");
    }
}
```

---

#### æµç¨‹3ï¼šç”¨æˆ·ä¸Šçº¿æ‹‰å–

```
Step 1: ç”¨æˆ·WebSocketè¿æ¥å»ºç«‹æˆåŠŸ

Step 2: Gatewayè°ƒç”¨Hook
POST {hookBaseUrl}/get-offline-messages
Body: {
    meta: {tenantId, requestId, timestamp, sign},
    userId: "user123",
    maxMessages: 100,
    cursor: ""
}

Step 3: ä¸šåŠ¡æ–¹æŸ¥è¯¢æ•°æ®åº“
var messages = await _db.OfflineMessages
    .Where(m => m.TenantId == tenantId 
             && m.UserId == userId 
             && m.Delivered == false)
    .OrderBy(m => m.Priority).ThenBy(m => m.CreatedAt)  // ä¼˜å…ˆçº§æ’åº
    .Take(maxMessages)
    .ToListAsync();

Step 4: å°è£…å“åº”
var response = new GetOfflineMessagesResponse {
    Ok = true,
    Messages = messages.Select(m => 
        MessageRequest.Parser.ParseFrom(m.MessageData)
    ).ToList(),
    NextCursor = hasMore ? GenerateCursor(messages.Last()) : "",
    HasMore = hasMore
};

Step 5: æ ‡è®°å·²æŠ•é€’ï¼ˆåŒæ­¥æ›´æ–°ï¼‰
foreach (var msg in messages) {
    msg.Delivered = true;
    msg.DeliveredAt = DateTimeOffset.UtcNow;
}
await _db.SaveChangesAsync();

return response;

Step 6: Gatewayæ¨é€ç»™å®¢æˆ·ç«¯
foreach (var msg in hookResponse.Messages) {
    await SendFrameAsync(socket, new ServerFrame {
        Delivery = new MessageDelivery { Message = msg }
    });
}

Step 7: åˆ†é¡µæ‹‰å–ï¼ˆå¦‚æœhasMore=trueï¼‰
while (hookResponse.HasMore) {
    hookResponse = await CallHookWithCursor(hookResponse.NextCursor);
    // ç»§ç»­æ¨é€...
}
```

---

### 3.4 åè®®æ‰©å±•

#### æ–°å¢Kafkaäº‹ä»¶ç±»å‹

```protobuf
// src/Mics.Contracts/Protos/mics_hook.proto

enum EventType {
  CONNECT_ONLINE = 0;
  CONNECT_OFFLINE = 1;
  SINGLE_CHAT_MSG = 2;
  GROUP_CHAT_MSG = 3;
  OFFLINE_MESSAGE = 4;  // ğŸ†• æ–°å¢
}

message MqEvent {
  string tenant_id = 1;
  EventType event_type = 2;
  string msg_id = 3;
  string user_id = 4;       // å‘é€æ–¹
  string device_id = 5;
  string to_user_id = 6;    // ğŸ†• æ¥æ”¶æ–¹ï¼ˆç¦»çº¿ç”¨æˆ·ï¼‰
  string group_id = 7;
  bytes event_data = 8;     // ğŸ†• MessageRequeståºåˆ—åŒ–æ•°æ®
  int64 timestamp = 9;
  string node_id = 10;
  string sign = 11;
  string trace_id = 12;
}
```

---

#### æ–°å¢Hookæ¥å£

```protobuf
// src/Mics.Contracts/Protos/mics_hook.proto

// æ‹‰å–ç¦»çº¿æ¶ˆæ¯
message GetOfflineMessagesRequest {
  HookMeta meta = 1;
  string user_id = 2;
  int32 max_messages = 3;   // æœ€å¤šæ‹‰å–æ¡æ•°ï¼ˆå»ºè®®100ï¼‰
  string cursor = 4;        // åˆ†é¡µæ¸¸æ ‡
}

message GetOfflineMessagesResponse {
  HookMeta meta = 1;
  bool ok = 2;
  repeated MessageRequest messages = 3;
  string reason = 4;
  string next_cursor = 5;   // ä¸‹ä¸€é¡µæ¸¸æ ‡
  bool has_more = 6;        // æ˜¯å¦è¿˜æœ‰æ›´å¤š
}
```

---

## 4. æŠ€æœ¯å®æ–½æ–¹æ¡ˆ

### 4.1 Gatewayç«¯æ”¹é€ 

#### æ”¹é€ ç‚¹1ï¼šç§»é™¤æœ¬åœ°å­˜å‚¨

```csharp
// åˆ é™¤ src/Mics.Gateway/Offline/OfflineBufferStore.cs çš„å†…å­˜å­˜å‚¨é€»è¾‘

// ä¿®æ”¹ WsGatewayHandler.cs
private async Task BufferOfflineAsync(
    ConnectionSession session, 
    string toUserId, 
    MessageRequest msg, 
    CancellationToken ct)
{
    // âŒ åˆ é™¤ï¼šæœ¬åœ°å­˜å‚¨
    // _offline.TryAdd(tenantId, userId, frameBytes, ttl);
    
    // âœ… æ–°å¢ï¼šæ¨é€Kafkaäº‹ä»¶
    _mq.TryEnqueue(MqEventFactory.CreateOfflineMessage(
        session.TenantId,
        toUserId,
        msg,
        _nodeId,
        session.TraceId,
        DateTimeOffset.UtcNow.ToUnixTimeMilliseconds(),
        session.TenantConfig.TenantSecret
    ));
    
    _metrics.CounterInc("mics_offline_notified_total", 1, 
        ("tenant", session.TenantId));
    
    _logger.LogInformation(
        "offline_message_notified to={ToUserId} msgId={MsgId}", 
        toUserId, msg.MsgId);
}
```

---

#### æ”¹é€ ç‚¹2ï¼šç”¨æˆ·ä¸Šçº¿æ‹‰å–

```csharp
// ä¿®æ”¹ WsGatewayHandler.cs
private async Task DrainOfflineAsync(
    ConnectionSession session, 
    CancellationToken ct)
{
    // âŒ åˆ é™¤ï¼šä»æœ¬åœ°å†…å­˜è¯»å–
    // var frames = _offline.Drain(tenantId, userId);
    
    // âœ… æ–°å¢ï¼šè°ƒç”¨Hookæ‹‰å–
    var cursor = "";
    var totalDrained = 0;
    
    while (true)
    {
        var result = await _hook.GetOfflineMessagesAsync(
            session.TenantConfig,
            session.TenantId,
            session.UserId,
            maxMessages: 100,
            cursor: cursor,
            ct);
        
        if (!result.Ok || result.Messages.Count == 0) {
            break;
        }
        
        // æ¨é€ç»™å®¢æˆ·ç«¯
        foreach (var msg in result.Messages) {
            if (session.Socket.State != WebSocketState.Open) {
                return;
            }
            
            await SendFrameAsync(session.Socket, new ServerFrame {
                Delivery = new MessageDelivery { Message = msg }
            }, ct);
            
            totalDrained++;
        }
        
        if (!result.HasMore) {
            break;
        }
        
        cursor = result.NextCursor;
        
        // é˜²æŠ¤ï¼šæœ€å¤šæ‹‰å–10é¡µï¼ˆ1000æ¡ï¼‰
        if (totalDrained >= 1000) {
            _logger.LogWarning(
                "offline_drain_limit_reached user={UserId} count={Count}", 
                session.UserId, totalDrained);
            break;
        }
    }
    
    if (totalDrained > 0) {
        _metrics.CounterInc("mics_offline_drained_from_hook", totalDrained, 
            ("tenant", session.TenantId));
    }
}
```

---

#### æ”¹é€ ç‚¹3ï¼šæ–°å¢Hookæ¥å£

```csharp
// src/Mics.Gateway/Hook/HookClient.cs

public interface IHookClient
{
    // ğŸ†• æ–°å¢æ¥å£
    ValueTask<GetOfflineMessagesResult> GetOfflineMessagesAsync(
        TenantRuntimeConfig config,
        string tenantId,
        string userId,
        int maxMessages,
        string cursor,
        CancellationToken ct);
}

internal sealed record GetOfflineMessagesResult(
    bool Ok, 
    bool Degraded,
    string Reason, 
    IReadOnlyList<MessageRequest> Messages,
    string NextCursor,
    bool HasMore
);

// å®ç°
public async ValueTask<GetOfflineMessagesResult> GetOfflineMessagesAsync(
    TenantRuntimeConfig config,
    string tenantId,
    string userId,
    int maxMessages,
    string cursor,
    CancellationToken ct)
{
    var policy = _policies.Resolve(tenantId, config);
    
    // ç†”æ–­å™¨æ£€æŸ¥
    if (!_breaker.TryBegin(tenantId, HookOperation.GetOfflineMessages)) {
        return new GetOfflineMessagesResult(
            Ok: false,
            Degraded: true,
            Reason: "circuit open",
            Messages: Array.Empty<MessageRequest>(),
            NextCursor: "",
            HasMore: false
        );
    }
    
    try {
        var meta = _metaFactory.Create(tenantId);
        var request = new GetOfflineMessagesRequest {
            Meta = meta,
            UserId = userId,
            MaxMessages = maxMessages,
            Cursor = cursor
        };
        
        // ç­¾å
        if (!string.IsNullOrWhiteSpace(config.TenantSecret)) {
            request.Meta.Sign = HmacSign.ComputeBase64(
                config.TenantSecret, request.Meta, PayloadForSign(request));
        }
        
        var url = config.HookBaseUrl.TrimEnd('/') + "/get-offline-messages";
        var post = await PostAsync(url, HookOperation.GetOfflineMessages, 
            tenantId, policy.Acquire, request, 
            GetOfflineMessagesResponse.Parser, ct);
        
        if (post.Response is null) {
            _breaker.OnFailure(tenantId, HookOperation.GetOfflineMessages, policy.Breaker);
            return new GetOfflineMessagesResult(false, true, "hook failed", 
                Array.Empty<MessageRequest>(), "", false);
        }
        
        _breaker.OnSuccess(tenantId, HookOperation.GetOfflineMessages);
        return new GetOfflineMessagesResult(
            post.Response.Ok,
            false,
            post.Response.Reason,
            post.Response.Messages,
            post.Response.NextCursor,
            post.Response.HasMore
        );
    }
    finally {
        _breaker.EndAttempt(tenantId, HookOperation.GetOfflineMessages);
    }
}
```

---

### 4.2 ä¸šåŠ¡æ–¹å®æ–½

#### æ•°æ®åº“Schemaè®¾è®¡

```sql
-- MySQLç¤ºä¾‹
CREATE TABLE offline_messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    tenant_id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    message_id VARCHAR(50) NOT NULL UNIQUE,  -- å»é‡
    from_user_id VARCHAR(50) NOT NULL,
    message_type ENUM('SINGLE_CHAT', 'GROUP_CHAT') NOT NULL,
    message_data BLOB NOT NULL,  -- MessageRequeståºåˆ—åŒ–
    priority INT DEFAULT 0,      -- ä¼˜å…ˆçº§ï¼ˆVIPç”¨æˆ·ï¼‰
    created_at TIMESTAMP NOT NULL,
    delivered BOOLEAN DEFAULT FALSE,
    delivered_at TIMESTAMP NULL,
    INDEX idx_user_delivered (tenant_id, user_id, delivered, priority, created_at),
    INDEX idx_created_at (created_at)  -- æ¸…ç†è¿‡æœŸæ•°æ®
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- MongoDBç¤ºä¾‹
db.createCollection("offline_messages", {
    validator: {
        $jsonSchema: {
            required: ["tenantId", "userId", "messageId", "messageData"],
            properties: {
                tenantId: { bsonType: "string" },
                userId: { bsonType: "string" },
                messageId: { bsonType: "string" },
                fromUserId: { bsonType: "string" },
                messageType: { enum: ["SINGLE_CHAT", "GROUP_CHAT"] },
                messageData: { bsonType: "binData" },
                priority: { bsonType: "int", minimum: 0 },
                delivered: { bsonType: "bool" },
                createdAt: { bsonType: "date" }
            }
        }
    }
});

db.offline_messages.createIndex(
    { "tenantId": 1, "userId": 1, "delivered": 1, "priority": -1, "createdAt": 1 }
);
db.offline_messages.createIndex({ "messageId": 1 }, { unique: true });
db.offline_messages.createIndex({ "createdAt": 1 }, { expireAfterSeconds: 2592000 });  // 30å¤©TTL
```

---

#### Kafkaæ¶ˆè´¹è€…å®ç°

```csharp
// ä¼ªä»£ç ç¤ºä¾‹
public class OfflineMessageConsumer : BackgroundService
{
    private readonly IConsumer<string, byte[]> _consumer;
    private readonly IOfflineMessageService _service;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        _consumer.Subscribe($"im-mics-{_tenantId}-event");
        
        while (!stoppingToken.IsCancellationRequested)
        {
            var consumeResult = _consumer.Consume(TimeSpan.FromSeconds(1));
            if (consumeResult == null) continue;
            
            var evt = MqEvent.Parser.ParseFrom(consumeResult.Message.Value);
            
            if (evt.EventType != EventType.OfflineMessage) {
                continue;
            }
            
            // éªŒè¯ç­¾å
            if (!VerifySign(evt)) {
                _logger.LogWarning("invalid_sign msgId={MsgId}", evt.MsgId);
                continue;
            }
            
            try {
                await _service.StoreOfflineMessageAsync(evt);
                _consumer.Commit(consumeResult);
            }
            catch (Exception ex) {
                _logger.LogError(ex, "store_failed msgId={MsgId}", evt.MsgId);
                // ä¸Commitï¼ŒKafkaä¼šé‡è¯•
            }
        }
    }
}

public class OfflineMessageService
{
    public async Task StoreOfflineMessageAsync(MqEvent evt)
    {
        var message = MessageRequest.Parser.ParseFrom(evt.EventData);
        
        // å»é‡æ£€æŸ¥
        if (await _db.OfflineMessages.AnyAsync(m => m.MessageId == evt.MsgId)) {
            return;  // é‡å¤æ¶ˆæ¯
        }
        
        // é»‘åå•è¿‡æ»¤
        if (await IsBlacklisted(evt.UserId, evt.ToUserId)) {
            _logger.LogInformation("blacklist_filtered from={From} to={To}", 
                evt.UserId, evt.ToUserId);
            return;
        }
        
        // ç¡®å®šä¼˜å…ˆçº§
        var priority = await GetPriority(evt.ToUserId);
        
        // å­˜å‚¨
        await _db.OfflineMessages.AddAsync(new OfflineMessage {
            TenantId = evt.TenantId,
            UserId = evt.ToUserId,
            MessageId = evt.MsgId,
            FromUserId = evt.UserId,
            MessageType = message.MsgType.ToString(),
            MessageData = evt.EventData.ToByteArray(),
            Priority = priority,
            CreatedAt = DateTimeOffset.FromUnixTimeMilliseconds(evt.Timestamp),
            Delivered = false
        });
        
        await _db.SaveChangesAsync();
        
        // è§¦å‘Appæ¨é€ï¼ˆå¯é€‰ï¼‰
        if (ShouldPushNotification(evt.ToUserId)) {
            await _pushService.SendAsync(evt.ToUserId, 
                $"{message.UserId}å‘æ¥æ–°æ¶ˆæ¯");
        }
    }
}
```

---

#### Hookæ¥å£å®ç°

```csharp
[ApiController]
[Route("api/hook")]
public class HookController : ControllerBase
{
    [HttpPost("get-offline-messages")]
    public async Task<GetOfflineMessagesResponse> GetOfflineMessages(
        [FromBody] GetOfflineMessagesRequest request)
    {
        // éªŒè¯ç­¾å
        var secret = await _tenantService.GetSecretAsync(request.Meta.TenantId);
        if (!VerifySign(request, secret)) {
            return new GetOfflineMessagesResponse {
                Meta = request.Meta,
                Ok = false,
                Reason = "invalid signature"
            };
        }
        
        // è§£æcursor
        var (skip, createdAt) = ParseCursor(request.Cursor);
        
        // æŸ¥è¯¢æ•°æ®åº“
        var query = _db.OfflineMessages
            .Where(m => m.TenantId == request.Meta.TenantId
                     && m.UserId == request.UserId
                     && m.Delivered == false);
        
        if (createdAt.HasValue) {
            query = query.Where(m => m.CreatedAt > createdAt.Value);
        }
        
        var messages = await query
            .OrderBy(m => m.Priority)      // é«˜ä¼˜å…ˆçº§ä¼˜å…ˆ
            .ThenBy(m => m.CreatedAt)      // æ—¶é—´å‡åº
            .Skip(skip)
            .Take(request.MaxMessages + 1) // å¤šæŸ¥1æ¡åˆ¤æ–­hasMore
            .ToListAsync();
        
        var hasMore = messages.Count > request.MaxMessages;
        if (hasMore) {
            messages = messages.Take(request.MaxMessages).ToList();
        }
        
        // å°è£…å“åº”
        var response = new GetOfflineMessagesResponse {
            Meta = request.Meta,
            Ok = true
        };
        
        foreach (var msg in messages) {
            var msgReq = MessageRequest.Parser.ParseFrom(msg.MessageData);
            response.Messages.Add(msgReq);
            
            // æ ‡è®°å·²æŠ•é€’
            msg.Delivered = true;
            msg.DeliveredAt = DateTimeOffset.UtcNow;
        }
        
        await _db.SaveChangesAsync();
        
        if (hasMore) {
            response.NextCursor = GenerateCursor(skip + messages.Count, 
                messages.Last().CreatedAt);
            response.HasMore = true;
        }
        
        return response;
    }
}
```

---

## 5. å®¹é”™ä¸é™çº§è®¾è®¡

### 5.1 Kafkaæ¨é€å¤±è´¥é™çº§

#### åœºæ™¯ï¼šKafkaé›†ç¾¤æ•…éšœ

```csharp
// Gatewayç«¯ï¼šå¼‚æ­¥é˜Ÿåˆ— + é‡è¯• + DLQï¼ˆbest-effortï¼Œä¸é˜»å¡ä¸»é“¾è·¯ï¼‰
//
// å…³é”®ç‚¹ï¼š
// 1) é˜Ÿåˆ—éœ€è¦â€œæŒ‰ç§Ÿæˆ·éš”ç¦»/é…é¢â€ï¼Œé¿å…å•ç§Ÿæˆ·æ´ªå³°å½±å“å…¶ä»–ç§Ÿæˆ·ï¼ˆå¼ºéš”ç¦»ï¼‰
// 2) é˜Ÿåˆ—æ»¡/æ¨é€å¤±è´¥å¿…é¡»æœ‰å¯è§‚æµ‹æ€§ï¼›å¿…è¦æ—¶å›é€€åˆ°çŸ­æœŸå†…å­˜ç¼“å†²ï¼ˆTTLï¼‰ä½œä¸ºé™çº§

public sealed class MqEventDispatcher
{
    // ç¤ºä¾‹ï¼šæ¯ç§Ÿæˆ·ä¸€ä¸ªæœ‰ç•Œé˜Ÿåˆ—ï¼ˆå®¹é‡å¯æŒ‰ç§Ÿæˆ·é…ç½®/é™æµï¼‰
    private readonly ConcurrentDictionary<string, Channel<MqEvent>> _tenantQueues = new();

    public bool TryEnqueue(string tenantId, MqEvent evt)
    {
        var q = _tenantQueues.GetOrAdd(tenantId, _ => Channel.CreateBounded<MqEvent>(
            new BoundedChannelOptions(10_000)
            {
                // é˜Ÿåˆ—æ»¡ï¼šä¸é˜»å¡ï¼ˆbest-effortï¼‰ï¼Œç”±è°ƒç”¨æ–¹å†³å®šæ˜¯å¦å›é€€çŸ­æœŸå†…å­˜ç¼“å†²
                FullMode = BoundedChannelFullMode.DropWrite
            }));

        var ok = q.Writer.TryWrite(evt);
        if (!ok)
        {
            // æŒ‡æ ‡/æ—¥å¿—å¿…é¡»æºå¸¦ tenantIdï¼Œä¾¿äºç§Ÿæˆ·çº§å‘Šè­¦ä¸éš”ç¦»æ’éšœ
            _metrics.CounterInc("mics_mq_dropped_total", 1, ("tenant", tenantId), ("reason", "queue_full"));
        }

        return ok;
    }

    // åå°å•çº¿ç¨‹ï¼šæ¶ˆè´¹é˜Ÿåˆ— â†’ Kafka produce â†’ å¤±è´¥é‡è¯• â†’ æœ€ç»ˆæŠ•é€’DLQï¼ˆä»å¯å¤±è´¥åˆ™è®¡æ•°ï¼‰
}
```

---

### 5.2 Hookæ‹‰å–å¤±è´¥é™çº§

#### åœºæ™¯ï¼šHookæœåŠ¡æ•…éšœ

```csharp
// Gatewayç«¯å®ç°å»¶è¿Ÿæ‹‰å– + é‡è¯•

private async Task DrainOfflineAsync(
    ConnectionSession session, 
    CancellationToken ct)
{
    var retryPolicy = Policy
        .Handle<Exception>()
        .WaitAndRetryAsync(3, 
            retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
            onRetry: (exception, timeSpan, retryCount, context) => {
                _logger.LogWarning(
                    "hook_retry attempt={Attempt} user={UserId}", 
                    retryCount, session.UserId);
            });
    
    try {
        await retryPolicy.ExecuteAsync(async () => {
            var result = await _hook.GetOfflineMessagesAsync(...);
            
            if (!result.Ok && !result.Degraded) {
                throw new Exception(result.Reason);  // è§¦å‘é‡è¯•
            }
            
            // æ¨é€æ¶ˆæ¯...
        });
    }
    catch (Exception ex) {
        // é‡è¯•3æ¬¡ä»å¤±è´¥ï¼Œæ”¾å¼ƒ
        _logger.LogWarning(ex, 
            "offline_drain_failed_after_retry user={UserId}", 
            session.UserId);
        
        _metrics.CounterInc("mics_offline_drain_failed_total", 1);
        
        // ä¸å½±å“è¿æ¥å»ºç«‹ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åˆ·æ–°
    }
}
```

---

### 5.3 ä¸šåŠ¡æ–¹å­˜å‚¨å¤±è´¥é™çº§

#### åœºæ™¯ï¼šMySQLå†™å…¥å¤±è´¥

```csharp
// ä¸šåŠ¡æ–¹å®ç°Redisç¼“å†²

public class OfflineMessageService
{
    public async Task StoreOfflineMessageAsync(MqEvent evt)
    {
        try {
            // æ­£å¸¸æµç¨‹ï¼šå†™å…¥MySQL
            await StoreToMySQLAsync(evt);
        }
        catch (DbException ex) {
            _logger.LogError(ex, "mysql_write_failed msgId={MsgId}", evt.MsgId);
            
            // é™çº§ï¼šå†™å…¥Redisç¼“å†²
            try {
                await _redis.ListRightPushAsync(
                    $"offline_buffer:{evt.ToUserId}",
                    evt.ToByteArray());
                
                await _redis.KeyExpireAsync(
                    $"offline_buffer:{evt.ToUserId}",
                    TimeSpan.FromHours(24));
                
                _logger.LogInformation("fallback_to_redis msgId={MsgId}", evt.MsgId);
            }
            catch {
                // Redisä¹Ÿå¤±è´¥ï¼Œè®°å½•åˆ°æœ¬åœ°æ–‡ä»¶
                await File.AppendAllTextAsync(
                    $"offline_lost_{DateTime.UtcNow:yyyyMMdd}.jsonl",
                    JsonSerializer.Serialize(evt) + "\n");
            }
        }
    }
    
    // åå°ä»»åŠ¡ï¼šRedisç¼“å†²è½ç›˜
    public async Task FlushRedisBufferAsync()
    {
        var users = await _redis.KeysAsync("offline_buffer:*");
        
        foreach (var key in users) {
            var messages = await _redis.ListRangeAsync(key, 0, -1);
            
            foreach (var msgBytes in messages) {
                var evt = MqEvent.Parser.ParseFrom(msgBytes);
                await StoreToMySQLAsync(evt);
            }
            
            await _redis.KeyDeleteAsync(key);
        }
    }
}
```

---

### 5.4 æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¹‚ç­‰æ€§

```csharp
// æ–¹æ¡ˆAï¼šæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼ˆæ¨èï¼‰
CREATE UNIQUE INDEX uk_message_id ON offline_messages(message_id);

// æ’å…¥æ—¶è‡ªåŠ¨å»é‡
try {
    await _db.OfflineMessages.AddAsync(newMessage);
    await _db.SaveChangesAsync();
}
catch (DbUpdateException ex) when (IsDuplicateKeyException(ex)) {
    // é‡å¤æ¶ˆæ¯ï¼Œå¿½ç•¥
    _logger.LogDebug("duplicate_message msgId={MsgId}", newMessage.MessageId);
}

// æ–¹æ¡ˆBï¼šRediså»é‡ç¼“å­˜ï¼ˆå¯é€‰ï¼ŒåŒé‡ä¿éšœï¼‰
var key = $"msg_processed:{evt.MsgId}";
if (!await _redis.StringSetAsync(key, "1", TimeSpan.FromDays(7), 
    When.NotExists)) {
    // å·²å¤„ç†è¿‡
    return;
}
```

---

## 6. æ€§èƒ½ä¸å®¹é‡è§„åˆ’

### 6.1 æ€§èƒ½æŒ‡æ ‡

#### Gatewayä¾§

```
ç¦»çº¿æ¶ˆæ¯äº§ç”Ÿï¼š
- Kafkaæ¨é€å»¶è¿Ÿ: P99 < 10msï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
- å†…å­˜å ç”¨: é™ä½80%ï¼ˆä¸å†ç¼“å­˜æ¶ˆæ¯ï¼‰
- TPSå½±å“: 0ï¼ˆå¼‚æ­¥æ¨é€ï¼‰

ç¦»çº¿æ¶ˆæ¯æ‹‰å–ï¼š
- Hookè°ƒç”¨å»¶è¿Ÿ: P99 < 200ms
- å•æ¬¡æ‹‰å–100æ¡æ¶ˆæ¯
- æ¨é€é€Ÿåº¦: ~1000æ¡/ç§’
```

---

#### ä¸šåŠ¡æ–¹ä¾§

```
Kafkaæ¶ˆè´¹ï¼š
- å•Consumeråå: 10K+ msg/s
- æ¶ˆè´¹å»¶è¿Ÿ: P99 < 100ms
- å­˜å‚¨å»¶è¿Ÿ: P99 < 50msï¼ˆMySQLä¼˜åŒ–åï¼‰

HookæŸ¥è¯¢ï¼š
- æŸ¥è¯¢å»¶è¿Ÿ: P99 < 100msï¼ˆç´¢å¼•ä¼˜åŒ–åï¼‰
- å¹¶å‘èƒ½åŠ›: 1000+ QPS
```

---

### 6.2 å®¹é‡è§„åˆ’

#### åœºæ™¯å‡è®¾

```
ç§Ÿæˆ·è§„æ¨¡ï¼š
- æ³¨å†Œç”¨æˆ·: 1000ä¸‡
- æ—¥æ´»ç”¨æˆ·: 100ä¸‡ï¼ˆ10%ï¼‰
- å¹³å‡åœ¨çº¿ç‡: 30%ï¼ˆ30ä¸‡åœ¨çº¿ï¼‰

æ¶ˆæ¯é‡ï¼š
- æ—¥æ¶ˆæ¯é‡: 5000ä¸‡æ¡
- ç¦»çº¿æ¶ˆæ¯å æ¯”: 40%ï¼ˆ2000ä¸‡æ¡/å¤©ï¼‰
- å¹³å‡æ¯ç”¨æˆ·ç¦»çº¿æ¶ˆæ¯: 20æ¡
```

---

#### Kafkaå®¹é‡

```
Topicé…ç½®ï¼š
- Partitions: 32
- Replication: 3
- Retention: 7å¤©

å­˜å‚¨è®¡ç®—ï¼š
- å•æ¡æ¶ˆæ¯å¤§å°: ~1KB
- æ—¥æ¶ˆæ¯é‡: 2000ä¸‡æ¡
- æ—¥å­˜å‚¨é‡: 2000ä¸‡ Ã— 1KB = 20GB
- 7å¤©å­˜å‚¨: 140GB
- è€ƒè™‘3å‰¯æœ¬: 420GB

æ¨èé…ç½®ï¼š
- ç£ç›˜: 1TB SSD
- å†…å­˜: 64GBï¼ˆPage Cacheï¼‰
- CPU: 16æ ¸
```

---

#### ä¸šåŠ¡æ–¹æ•°æ®åº“å®¹é‡

```
MySQLå­˜å‚¨ï¼š
- å•æ¡è®°å½•: ~2KBï¼ˆåŒ…å«ç´¢å¼•ï¼‰
- æ—¥æ–°å¢: 2000ä¸‡æ¡ Ã— 2KB = 40GB
- æœˆå­˜å‚¨: 1.2TB
- ä¿ç•™30å¤©: 1.2TB

ä¼˜åŒ–å»ºè®®ï¼š
1. åˆ†è¡¨ç­–ç•¥
   - æŒ‰userId Hashåˆ†è¡¨ï¼ˆ256å¼ è¡¨ï¼‰
   - å•è¡¨æ—¥å¢: 40GB / 256 = 156MB

2. å†·çƒ­åˆ†ç¦»
   - çƒ­æ•°æ®ï¼ˆ7å¤©ï¼‰: Redis + MySQL
   - æ¸©æ•°æ®ï¼ˆ8-30å¤©ï¼‰: MySQL
   - å†·æ•°æ®ï¼ˆ>30å¤©ï¼‰: å½’æ¡£åˆ°S3

3. ç´¢å¼•ä¼˜åŒ–
   - ä¸»é”®ç´¢å¼•: id
   - å”¯ä¸€ç´¢å¼•: message_id
   - å¤åˆç´¢å¼•: (tenant_id, user_id, delivered, priority, created_at)
```

---

## 7. å®æ–½è·¯çº¿å›¾

### é˜¶æ®µ1ï¼šåè®®å®šä¹‰ä¸è®¾è®¡è¯„å®¡ï¼ˆ1å‘¨ï¼‰

```
Week 1:
Day 1-2: 
  âœ… å®šä¹‰OFFLINE_MESSAGEäº‹ä»¶æ ¼å¼
  âœ… å®šä¹‰GetOfflineMessages Hookæ¥å£
  âœ… æ›´æ–°Protobufæ–‡ä»¶

Day 3-4:
  âœ… è¯„å®¡æŠ€æœ¯æ–¹æ¡ˆ
  âœ… ç¡®å®šæ•°æ®åº“Schema
  âœ… ç¡®å®šé™çº§ç­–ç•¥

Day 5:
  âœ… ç¼–å†™è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
  âœ… åˆ¶å®šæµ‹è¯•è®¡åˆ’
```

---

### é˜¶æ®µ2ï¼šGatewayç«¯æ”¹é€ ï¼ˆ2å‘¨ï¼‰

```
Week 2:
  âœ… ä¿®æ”¹OfflineBufferStoreé€»è¾‘
  âœ… å®ç°Kafkaäº‹ä»¶æ¨é€
  âœ… æ–°å¢MqEventFactory.CreateOfflineMessage
  âœ… å•å…ƒæµ‹è¯•

Week 3:
  âœ… å®ç°Hookæ‹‰å–é€»è¾‘
  âœ… æ–°å¢HookClient.GetOfflineMessagesAsync
  âœ… å®ç°é™çº§ç­–ç•¥
  âœ… é›†æˆæµ‹è¯•
```

---

### é˜¶æ®µ3ï¼šä¸šåŠ¡æ–¹å®ç°ï¼ˆ2-3å‘¨ï¼‰

```
Week 4:
  âœ… æ•°æ®åº“Schemaè®¾è®¡ä¸åˆ›å»º
  âœ… Kafkaæ¶ˆè´¹è€…å¼€å‘
  âœ… å­˜å‚¨æœåŠ¡å®ç°
  âœ… å»é‡ã€è¿‡æ»¤é€»è¾‘

Week 5:
  âœ… Hookæ¥å£å®ç°
  âœ… æŸ¥è¯¢ä¼˜åŒ–ï¼ˆç´¢å¼•ï¼‰
  âœ… é™çº§ç­–ç•¥å®ç°
  âœ… å•å…ƒæµ‹è¯•

Week 6:
  âœ… æ€§èƒ½æµ‹è¯•
  âœ… å‹åŠ›æµ‹è¯•
  âœ… ç›‘æ§é¢æ¿æ­å»º
```

---

### é˜¶æ®µ4ï¼šç°åº¦å‘å¸ƒï¼ˆ2å‘¨ï¼‰

```
Week 7:
  âœ… é€‰æ‹©å°ç§Ÿæˆ·ï¼ˆ1000ç”¨æˆ·ï¼‰è¯•ç‚¹
  âœ… åŒå†™éªŒè¯ï¼ˆæ—§æ–¹æ¡ˆ+æ–°æ–¹æ¡ˆï¼‰
  âœ… ç›‘æ§å…³é”®æŒ‡æ ‡
  âœ… æ”¶é›†ç”¨æˆ·åé¦ˆ

Week 8:
  âœ… ä¿®å¤å‘ç°çš„é—®é¢˜
  âœ… æ‰©å¤§ç°åº¦èŒƒå›´ï¼ˆ1ä¸‡ç”¨æˆ·ï¼‰
  âœ… æ€§èƒ½è°ƒä¼˜
  âœ… å‡†å¤‡å…¨é‡ä¸Šçº¿
```

---

### é˜¶æ®µ5ï¼šå…¨é‡ä¸Šçº¿ï¼ˆ1å‘¨ï¼‰

```
Week 9:
  âœ… æ‰€æœ‰ç§Ÿæˆ·åˆ‡æ¢åˆ°æ–°æ–¹æ¡ˆ
  âœ… å…³é—­æ—§é€»è¾‘ï¼ˆOfflineBufferStoreï¼‰
  âœ… ç›‘æ§7å¤©ç¡®ä¿ç¨³å®š
  âœ… æ–‡æ¡£æ›´æ–°
  âœ… å›¢é˜ŸåŸ¹è®­
```

---

## 8. é£é™©è¯„ä¼°ä¸åº”å¯¹

### 8.1 æŠ€æœ¯é£é™©

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|------|------|---------|
| **Kafkaæ•…éšœ** | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | æœ¬åœ°é˜Ÿåˆ—ç¼“å†² + å‘Šè­¦ + å¿«é€Ÿåˆ‡æ¢å¤‡ç”¨é›†ç¾¤ |
| **Hookè¶…æ—¶** | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | é‡è¯•3æ¬¡ + é™çº§è·³è¿‡ + å®¢æˆ·ç«¯æ‰‹åŠ¨åˆ·æ–° |
| **MySQLå†™å…¥æ…¢** | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | åˆ†è¡¨ + ç´¢å¼•ä¼˜åŒ– + Redisç¼“å†² |
| **æ¶ˆè´¹ç§¯å‹** | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | å¢åŠ Consumerå®ä¾‹ + æ‰©å®¹åˆ†åŒº |
| **æ•°æ®ä¸€è‡´æ€§** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | å”¯ä¸€ç´¢å¼• + å¹‚ç­‰æ¶ˆè´¹ + å¯¹è´¦ä»»åŠ¡ |

---

### 8.2 ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|------|------|---------|
| **ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿå¢åŠ ** | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | Hookæ€§èƒ½ä¼˜åŒ– + åˆ†é¡µæ‹‰å– + æç¤ºä¼˜åŒ– |
| **å†å²æ¶ˆæ¯ä¸¢å¤±** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | åŒå†™éªŒè¯é˜¶æ®µ + æ•°æ®å¯¹è´¦ + å›æ»šé¢„æ¡ˆ |
| **å®æ–½å¤±è´¥** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | å……åˆ†æµ‹è¯• + ç°åº¦å‘å¸ƒ + å¿«é€Ÿå›æ»š |

---

### 8.3 å›æ»šé¢„æ¡ˆ

```
åœºæ™¯ï¼šæ–°æ–¹æ¡ˆå‡ºç°ä¸¥é‡é—®é¢˜

å¿«é€Ÿå›æ»šæ­¥éª¤ï¼š
1. åœæ­¢Gatewayæ–°ç‰ˆæœ¬éƒ¨ç½²
2. å›æ»šåˆ°æ—§ç‰ˆæœ¬ä»£ç 
3. æ¢å¤OfflineBufferStoreé€»è¾‘
4. ä¸šåŠ¡æ–¹åœæ­¢Kafkaæ¶ˆè´¹
5. ç›‘æ§ç¡®è®¤ç³»ç»Ÿæ¢å¤æ­£å¸¸

å›æ»šæ—¶é—´ï¼š< 30åˆ†é’Ÿ

æ•°æ®å½±å“ï¼š
- å›æ»šæœŸé—´çš„ç¦»çº¿æ¶ˆæ¯å¯èƒ½ä¸¢å¤±
- é€šè¿‡Kafkaå›æº¯å¯ä»¥æ¢å¤
```

---

## 9. ç›‘æ§ä¸è¿ç»´

### 9.1 å…³é”®æŒ‡æ ‡

#### Gatewayä¾§

```
# Kafkaæ¨é€ç›¸å…³
mics_offline_notified_total            # ç¦»çº¿æ¶ˆæ¯é€šçŸ¥æ€»æ•°
mics_kafka_queue_depth                 # Kafkaæœ¬åœ°é˜Ÿåˆ—æ·±åº¦
mics_kafka_push_failed_total           # Kafkaæ¨é€å¤±è´¥æ•°

# Hookæ‹‰å–ç›¸å…³
mics_offline_drain_requests_total      # Hookæ‹‰å–è¯·æ±‚æ•°
mics_offline_drained_from_hook         # ä»Hookæ‹‰å–çš„æ¶ˆæ¯æ•°
mics_offline_drain_failed_total        # Hookæ‹‰å–å¤±è´¥æ•°
mics_hook_get_offline_duration_ms      # Hookæ‹‰å–å»¶è¿Ÿ
```

---

#### ä¸šåŠ¡æ–¹ä¾§

```
# å­˜å‚¨ç›¸å…³
offline_message_consumed_total         # Kafkaæ¶ˆè´¹æ€»æ•°
offline_message_stored_total           # æˆåŠŸå­˜å‚¨æ€»æ•°
offline_message_store_failed_total     # å­˜å‚¨å¤±è´¥æ€»æ•°
offline_message_store_duration_ms      # å­˜å‚¨å»¶è¿Ÿ

# æŸ¥è¯¢ç›¸å…³
offline_message_query_total            # HookæŸ¥è¯¢æ€»æ•°
offline_message_query_duration_ms      # æŸ¥è¯¢å»¶è¿Ÿ
offline_message_query_count            # å•æ¬¡æŸ¥è¯¢è¿”å›æ•°é‡

# Kafkaæ¶ˆè´¹è€…
kafka_consumer_lag                     # æ¶ˆè´¹å»¶è¿Ÿ
kafka_consumer_offset                  # å½“å‰offset
```

---

### 9.2 å‘Šè­¦è§„åˆ™

```yaml
# Prometheus AlertManageré…ç½®

groups:
  - name: offline_message_alerts
    rules:
      # Gatewayä¾§
      - alert: KafkaQueueDepthHigh
        expr: mics_kafka_queue_depth > 5000
        for: 5m
        annotations:
          summary: "Kafkaé˜Ÿåˆ—ç§¯å‹ä¸¥é‡"
          
      - alert: OfflineDrainFailureRateHigh
        expr: rate(mics_offline_drain_failed_total[5m]) > 0.1
        for: 5m
        annotations:
          summary: "Hookæ‹‰å–å¤±è´¥ç‡è¿‡é«˜"
      
      # ä¸šåŠ¡æ–¹ä¾§
      - alert: KafkaConsumerLagHigh
        expr: kafka_consumer_lag > 10000
        for: 10m
        annotations:
          summary: "Kafkaæ¶ˆè´¹å»¶è¿Ÿè¿‡é«˜"
          
      - alert: OfflineStoreFailureRateHigh
        expr: rate(offline_message_store_failed_total[5m]) > 0.05
        for: 5m
        annotations:
          summary: "ç¦»çº¿æ¶ˆæ¯å­˜å‚¨å¤±è´¥ç‡è¿‡é«˜"
```

---

### 9.3 æ—¥å¸¸è¿ç»´

#### æ•°æ®æ¸…ç†ä»»åŠ¡

```sql
-- MySQLå®šæ—¶æ¸…ç†30å¤©å‰å·²æŠ•é€’æ¶ˆæ¯
DELETE FROM offline_messages
WHERE delivered = TRUE 
  AND delivered_at < DATE_SUB(NOW(), INTERVAL 30 DAY)
LIMIT 10000;

-- å»ºè®®ï¼šæ¯å¤©å‡Œæ™¨æ‰§è¡Œï¼Œåˆ†æ‰¹åˆ é™¤
```

---

#### æ•°æ®å¯¹è´¦ä»»åŠ¡

```csharp
// æ¯å¤©å¯¹è´¦Kafkaä¸MySQLæ•°æ®ä¸€è‡´æ€§
public async Task ReconcileDataAsync(DateOnly date)
{
    // ç»Ÿè®¡Kafkaè¯¥å¤©çš„OFFLINE_MESSAGEäº‹ä»¶æ•°
    var kafkaCount = await CountKafkaEventsAsync(date);
    
    // ç»Ÿè®¡MySQLè¯¥å¤©æ–°å¢è®°å½•æ•°
    var dbCount = await _db.OfflineMessages
        .Where(m => m.CreatedAt.Date == date.ToDateTime(TimeOnly.MinValue))
        .CountAsync();
    
    if (Math.Abs(kafkaCount - dbCount) > kafkaCount * 0.01) {  // å·®å¼‚>1%
        _alertService.Send("æ•°æ®å¯¹è´¦å¤±è´¥", 
            $"Kafka:{kafkaCount}, DB:{dbCount}, Diff:{Math.Abs(kafkaCount - dbCount)}");
    }
}
```

---

## 10. æ€»ç»“ä¸å»ºè®®

### 10.1 æ–¹æ¡ˆä»·å€¼

#### æ¶æ„å±‚é¢

```
âœ… Gatewayå®Œå…¨æ— çŠ¶æ€åŒ–
   - èŠ‚ç‚¹å¯éšæ„é‡å¯æ‰©ç¼©å®¹
   - è¿ç»´æˆæœ¬å¤§å¹…é™ä½
   - ç³»ç»Ÿå¯ç”¨æ€§æå‡

âœ… èŒè´£åˆ†ç¦»æ¸…æ™°
   - Gateway: å®æ—¶è½¬å‘å±‚
   - Kafka: å¼‚æ­¥é€šçŸ¥å±‚
   - ä¸šåŠ¡æ–¹: æ•°æ®æŒä¹…å±‚
   - å„å±‚ç‹¬ç«‹æ¼”è¿›

âœ… å¯æ‰©å±•æ€§å¼º
   - Kafkaåˆ†åŒºå¹¶è¡Œæ¶ˆè´¹
   - ä¸šåŠ¡æ–¹æ¨ªå‘æ‰©å±•
   - æ— ç“¶é¢ˆç‚¹
```

---

#### ä¸šåŠ¡å±‚é¢

```
âœ… å¯é æ€§è¾¹ç•Œæ¸…æ™°ï¼ˆbest-effortï¼‰
   - å¯é æ€§ä¸»ä½“åœ¨ä¸šåŠ¡ä¾§ï¼ˆKafkaæ¶ˆè´¹ + å­˜å‚¨ + å¹‚ç­‰ï¼‰
   - Gateway ä»…è´Ÿè´£ç¦»çº¿äº‹ä»¶é€šçŸ¥ä¸ä¸Šçº¿æ‹‰å–è¡¥å‘ï¼Œä¸åšå¿…è¾¾æ‰¿è¯º

âœ… ä¸šåŠ¡çµæ´»æ€§æå¼º
   - å»é‡ã€è¿‡æ»¤ã€ä¼˜å…ˆçº§å®Œå…¨å¯æ§
   - å­˜å‚¨æ–¹æ¡ˆè‡ªé€‰
   - æ¨é€ç­–ç•¥è‡ªå®šä¹‰

âœ… å¯è§‚æµ‹æ€§å¼º
   - å…¨é“¾è·¯TraceIdè¿½è¸ª
   - Kafkaäº‹ä»¶å¯å›æº¯
   - å¤šç»´åº¦ç›‘æ§æŒ‡æ ‡
```

---

### 10.2 æœ€ç»ˆå»ºè®®

#### æ¨èé‡‡ç”¨æœ¬æ–¹æ¡ˆçš„ç†ç”±

1. **ç¬¦åˆæ¶æ„åŸåˆ™** â­â­â­â­â­
   - Gatewayä¸å­˜å‚¨ä¸šåŠ¡æ•°æ®
   - èŒè´£åˆ†ç¦»æ¸…æ™°
   - é•¿æœŸæ¶æ„å¥åº·

2. **å¯é æ€§ä¿éšœ** â­â­â­â­â­
   - Kafka + æ•°æ®åº“åŒé‡ä¿éšœ
   - æ¶ˆæ¯ä¸ä¸¢å¤±
   - ç”¨æˆ·ä½“éªŒæœ‰ä¿è¯

3. **æ€§èƒ½ä¼˜å¼‚** â­â­â­â­â­
   - å¼‚æ­¥éé˜»å¡
   - ä¸å½±å“å®æ—¶æ¶ˆæ¯
   - å¯çº¿æ€§æ‰©å±•

4. **ä¸šåŠ¡ä»·å€¼** â­â­â­â­â­
   - ä¸šåŠ¡æ–¹å®Œå…¨æ§åˆ¶
   - å¯å®ç°å¤æ‚é€»è¾‘
   - æ•°æ®ä»·å€¼å¯æŒ–æ˜

---

#### å®æ–½å»ºè®®

```
âœ… å……åˆ†æµ‹è¯•
   - å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
   - é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒåœºæ™¯
   - å‹åŠ›æµ‹è¯•éªŒè¯æ€§èƒ½

âœ… ç°åº¦å‘å¸ƒ
   - å°ç§Ÿæˆ·è¯•ç‚¹ â†’ ä¸­å‹ç§Ÿæˆ· â†’ å…¨é‡
   - æ¯ä¸ªé˜¶æ®µè§‚å¯Ÿ1å‘¨
   - å‘ç°é—®é¢˜ç«‹å³ä¿®å¤

âœ… ç›‘æ§å®Œå–„
   - æ­å»ºGrafana Dashboard
   - é…ç½®AlertManagerå‘Šè­¦
   - å»ºç«‹On-Callæœºåˆ¶

âœ… æ–‡æ¡£å®Œæ•´
   - æŠ€æœ¯æ–‡æ¡£
   - è¿ç»´æ‰‹å†Œ
   - FAQæ€»ç»“
   - å›¢é˜ŸåŸ¹è®­
```

---

### 10.3 é¢„æœŸæ”¶ç›Š

#### å®šé‡æ”¶ç›Š

```
Gatewayä¾§ï¼š
- å†…å­˜å ç”¨: é™ä½ 80%
- èŠ‚ç‚¹é‡å¯å½±å“: ä»100%é™è‡³ 0%
- ç¦»çº¿æ¶ˆæ¯å¯é æ€§: ä»â€œèŠ‚ç‚¹å†…å­˜æ˜“å¤±â€è¿ç§»ä¸ºâ€œä¸šåŠ¡ä¾§å¯æŒä¹…åŒ–ä¿éšœâ€ï¼ˆGatewayä¸ºbest-effortï¼‰

ä¸šåŠ¡æ–¹ä¾§ï¼š
- ç¦»çº¿æ¶ˆæ¯å¤„ç†çµæ´»æ€§: ä»0æå‡è‡³ 100%
- æ•°æ®åˆ†æèƒ½åŠ›: æ–°å¢èƒ½åŠ›
- ç”¨æˆ·æ»¡æ„åº¦: æå‡ 20%+ï¼ˆé¢„ä¼°ï¼‰

ç³»ç»Ÿæ•´ä½“ï¼š
- ç³»ç»Ÿå¯ç”¨æ€§: ä»95%æå‡è‡³ 99.95%+
- è¿ç»´æˆæœ¬: é™ä½ 30%
- æ‰©å±•æ€§: ä»å—é™æå‡è‡³çº¿æ€§æ‰©å±•
```

---

#### å®šæ€§æ”¶ç›Š

```
âœ… æŠ€æœ¯å›¢é˜Ÿï¼š
   - æ¶æ„æ›´æ¸…æ™°
   - ä»£ç æ›´æ˜“ç»´æŠ¤
   - ä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½ä¼˜åŒ–

âœ… ä¸šåŠ¡å›¢é˜Ÿï¼š
   - å®Œå…¨æ§åˆ¶ç¦»çº¿æ¶ˆæ¯é€»è¾‘
   - å¯å®ç°ä¸°å¯Œä¸šåŠ¡åŠŸèƒ½
   - æ•°æ®ä»·å€¼å¯æ·±åº¦æŒ–æ˜

âœ… ç”¨æˆ·ï¼š
   - æ¶ˆæ¯ä¸ä¸¢å¤±
   - ä¸Šçº¿åå¿«é€Ÿæ”¶åˆ°ç¦»çº¿æ¶ˆæ¯
   - æ•´ä½“ä½“éªŒæ›´ç¨³å®š
```

---

### 10.4 æˆåŠŸæ ‡å‡†

```
æŠ€æœ¯æŒ‡æ ‡ï¼š
âœ… ç¦»çº¿æ¶ˆæ¯ä¸¢å¤±ç‡ < 0.01%
âœ… Hookæ‹‰å–P99å»¶è¿Ÿ < 200ms
âœ… Kafkaæ¶ˆè´¹å»¶è¿Ÿ < 100ms
âœ… ç³»ç»Ÿå¯ç”¨æ€§ > 99.95%

ä¸šåŠ¡æŒ‡æ ‡ï¼š
âœ… ç”¨æˆ·æŠ•è¯‰ç‡ä¸‹é™ > 50%
âœ… ç¦»çº¿æ¶ˆæ¯åˆ°è¾¾ç‡ > 99.9%
âœ… ç”¨æˆ·æ»¡æ„åº¦æå‡ > 20%
```

---

## é™„å½•

### A. å‚è€ƒæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®Œæ•´æŠ€æœ¯æ¶æ„å›¾                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯      â”‚
â”‚  (WebSocket) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gatewayé›†ç¾¤ï¼ˆæ— çŠ¶æ€ï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Node 1  â”‚  â”‚ Node 2  â”‚  â”‚ Node 3  â”‚  â”‚ Node N  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚            â”‚            â”‚            â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                     â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Redis  â”‚   â”‚  Kafka  â”‚   â”‚  Hook   â”‚
  â”‚ (è·¯ç”±è¡¨) â”‚   â”‚ (äº‹ä»¶)   â”‚   â”‚ (ä¸šåŠ¡)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚             â”‚
                     â–¼             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      ä¸šåŠ¡ç³»ç»Ÿï¼ˆè‡ªä¸»ï¼‰       â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
              â”‚  â”‚ Kafka Consumer   â”‚   â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
              â”‚           â–¼             â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
              â”‚  â”‚  MySQL/MongoDB   â”‚   â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
              â”‚           â–²             â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
              â”‚  â”‚  Hook API Server â”‚   â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### B. å¸¸è§é—®é¢˜FAQ

#### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Redis Streamï¼Ÿ
A: Redis Streamä»ç„¶æ˜¯Gatewayå­˜å‚¨ä¸šåŠ¡æ•°æ®ï¼Œè¿èƒŒæ¶æ„åŸåˆ™ï¼Œä¸”å®¹é‡æœ‰é™ã€æˆæœ¬é«˜ã€‚

#### Q2: Kafkaæ•…éšœæ€ä¹ˆåŠï¼Ÿ
A: Gatewayæœ¬åœ°é˜Ÿåˆ—ç¼“å†² + å‘Šè­¦ + å¿«é€Ÿåˆ‡æ¢å¤‡ç”¨Kafkaé›†ç¾¤ã€‚

#### Q3: Hookè°ƒç”¨å»¶è¿Ÿé«˜æ€ä¹ˆåŠï¼Ÿ
A: ä¸šåŠ¡æ–¹ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆç´¢å¼•ã€åˆ†è¡¨ã€Redisç¼“å­˜ï¼‰+ Gatewayé‡è¯•æœºåˆ¶ã€‚

#### Q4: æ¶ˆæ¯ä¼šé‡å¤å—ï¼Ÿ
A: ä¸šåŠ¡æ–¹é€šè¿‡æ•°æ®åº“å”¯ä¸€ç´¢å¼•ä¿è¯å¹‚ç­‰æ€§ï¼Œä¸ä¼šé‡å¤å­˜å‚¨ã€‚

#### Q5: å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåºï¼Ÿ
A: Kafka Partition Keyä½¿ç”¨userIdï¼ŒåŒä¸€ç”¨æˆ·æ¶ˆæ¯é¡ºåºæœ‰ä¿è¯ã€‚

---

### C. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **Gateway** | MICSæ¶ˆæ¯ç½‘å…³ï¼Œè´Ÿè´£å®æ—¶æ¶ˆæ¯è½¬å‘ |
| **ç¦»çº¿æ¶ˆæ¯** | ç”¨æˆ·ä¸åœ¨çº¿æ—¶æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œéœ€è¦ç¼“å­˜åæ¨é€ |
| **Kafka** | åˆ†å¸ƒå¼æµå¤„ç†å¹³å°ï¼Œç”¨äºå¼‚æ­¥äº‹ä»¶é€šçŸ¥ |
| **Hook** | ä¸šåŠ¡æ–¹æä¾›çš„HTTPæ¥å£ï¼Œç”¨äºä¸šåŠ¡é€»è¾‘æ‰©å±• |
| **å¹‚ç­‰æ€§** | é‡å¤æ‰§è¡ŒåŒä¸€æ“ä½œç»“æœç›¸åŒ |
| **é™çº§** | ç³»ç»Ÿæ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ |

---

